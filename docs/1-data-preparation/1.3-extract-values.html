<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Extract covariate values</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="1.3-extract-values_files/libs/clipboard/clipboard.min.js"></script>
<script src="1.3-extract-values_files/libs/quarto-html/quarto.js"></script>
<script src="1.3-extract-values_files/libs/quarto-html/popper.min.js"></script>
<script src="1.3-extract-values_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="1.3-extract-values_files/libs/quarto-html/anchor.min.js"></script>
<link href="1.3-extract-values_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="1.3-extract-values_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="1.3-extract-values_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="1.3-extract-values_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="1.3-extract-values_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Extract covariate values</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Objectives:</p>
<ul>
<li>Extract raster covariate values</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>terra 1.7.78</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::extract() masks terra::extract()
✖ dplyr::filter()  masks stats::filter()
✖ dplyr::lag()     masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">5228</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="presence-data" class="level2">
<h2 class="anchored" data-anchor-id="presence-data">Presence data</h2>
<p><strong>Prepare presence and availability points</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gps <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">'../../data/yt_caribou.gpkg'</span>, <span class="st">'gps'</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">individual=</span>ID, <span class="at">occurrence=</span><span class="dv">1</span>, <span class="at">ID=</span><span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>season<span class="sc">==</span><span class="st">'other'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `gps' from data source 
  `C:\Users\PIVER37\Desktop\Projects\little_rancheria\data\yt_caribou.gpkg' 
  using driver `GPKG'
Simple feature collection with 90864 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 518681.7 ymin: 480918.5 xmax: 716666.7 ymax: 651698.2
Projected CRS: NAD83 / Yukon Albers</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(gps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 77,091
Columns: 5
$ timestamp  &lt;chr&gt; "2020-11-06 19:10:39", "2020-11-07 01:07:00", "2020-11-07 0…
$ season     &lt;chr&gt; "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
$ geom       &lt;POINT [m]&gt; POINT (678102.7 642940.6), POINT (675905.1 636811.4),…
$ individual &lt;int&gt; 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
$ occurrence &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…</code></pre>
</div>
</div>
<p><strong>Calculate proportion of locations for each individual caribou</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>gps_id_prop <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gps, individual) <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n=</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">freq=</span>n<span class="sc">/</span><span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>gps_id_prop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.053988144 0.054104889 0.053741682 0.054182719 0.054143804 0.054117861
 [7] 0.054014087 0.024205160 0.026916242 0.026060111 0.008366735 0.020495259
[13] 0.054195691 0.053988144 0.054078946 0.009508244 0.005785371 0.053988144
[19] 0.024205160 0.054130832 0.054027059 0.019691015 0.024010585 0.053988144
[25] 0.054065974</code></pre>
</div>
</div>
<p><strong>Read predictor rasters and concatenate them</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>landcov <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">'../../data/raster30/landcov.tif'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>topo <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">'../../data/raster30/topo.tif'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>fires <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">'../../data/raster30/fires.tif'</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>dist2line <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">'../../data/raster30/dist2line.tif'</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dist2line) <span class="ot">&lt;-</span> <span class="st">"dist2line"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>dist2poly <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">'../../data/raster30/dist2poly.tif'</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(dist2poly) <span class="ot">&lt;-</span> <span class="st">"dist2poly"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>rasters <span class="ot">&lt;-</span> <span class="fu">c</span>(landcov, topo, fires, dist2line, dist2poly)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(rasters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "forest"    "conifer"   "broadleaf" "mixedwood" "wetland"   "shrubland"
 [7] "grassland" "barren"    "snowice"   "elevation" "slope"     "aspect"   
[13] "roughness" "northness" "eastness"  "fires"     "dist2line" "dist2poly"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>rasters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 6694, 7600, 18  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 503670, 731670, 465900, 666720  (xmin, xmax, ymin, ymax)
coord. ref. : NAD83 / Yukon Albers (EPSG:3578) 
sources     : landcov.tif  (9 layers) 
              topo.tif  (6 layers) 
              fires.tif  
              ... and 2 more source(s)
names       : forest, conifer, broadleaf, mixedwood, wetland, shrubland, ... 
min values  :      0,       0,         0,         0,       0,         0, ... 
max values  :      1,       1,         1,         1,       1,         1, ... </code></pre>
</div>
</div>
<p><strong>Extract raster values for GPS locations</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pres_vars <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(rasters, gps) <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID=</span><span class="cn">NULL</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pres_vars_sf <span class="ot">&lt;-</span> <span class="fu">cbind</span>(gps, pres_vars)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>pres_vars_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 77091 features and 22 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 518681.7 ymin: 480918.5 xmax: 716666.7 ymax: 651698.2
Projected CRS: NAD83 / Yukon Albers
First 10 features:
             timestamp      season individual occurrence forest conifer
1  2020-11-06 19:10:39 earlywinter      43163          1      1       1
2  2020-11-07 01:07:00 earlywinter      43163          1      1       1
3  2020-11-07 07:05:54 earlywinter      43163          1      1       1
4  2020-11-07 13:04:39 earlywinter      43163          1      1       1
5  2020-11-07 19:03:23 earlywinter      43163          1      1       1
6  2020-11-08 01:02:25 earlywinter      43163          1      1       1
7  2020-11-08 07:03:25 earlywinter      43163          1      1       1
8  2020-11-08 13:00:38 earlywinter      43163          1      1       1
9  2020-11-08 18:59:39 earlywinter      43163          1      1       1
10 2020-11-09 00:58:38 earlywinter      43163          1      1       1
   broadleaf mixedwood wetland shrubland grassland barren snowice elevation
1          0         0       0         0         0      0       0  688.2874
2          0         0       0         0         0      0       0  721.8030
3          0         0       0         0         0      0       0  732.6952
4          0         0       0         0         0      0       0  734.0319
5          0         0       0         0         0      0       0  725.3831
6          0         0       0         0         0      0       0  741.4588
7          0         0       0         0         0      0       0  748.1053
8          0         0       0         0         0      0       0  735.0618
9          0         0       0         0         0      0       0  728.0272
10         0         0       0         0         0      0       0  728.3869
       slope    aspect roughness   northness   eastness fires dist2line
1  1.3049368  76.21446 1.6730957  0.23828828  0.9711944     0  2468.400
2  1.1596124  13.66821 1.4671021  0.97168040  0.2362990     0   870.000
3  0.6464857  54.27378 0.9449463  0.58391279  0.8118164     0  3113.069
4  0.5722326  48.41456 0.8459473  0.66373616  0.7479668     0  3340.793
5  0.8816819 106.66216 1.1493530 -0.28672776  0.9580121     0  3495.612
6  1.1163176 138.72826 1.6526489 -0.75158954  0.6596311     0  3180.000
7  1.0377831  85.68446 1.1655884  0.07524924  0.9971648     0  3930.000
8  1.4175920  96.07789 1.6336670 -0.10588032  0.9943789     0  3822.735
9  0.4276250 197.99167 0.5642700 -0.95110142 -0.3088788     0  3976.896
10 0.9032347  61.24379 1.2843628  0.48108381  0.8766746     0  2886.399
   dist2poly                      geom
1   2539.390 POINT (678102.7 642940.6)
2   2309.026 POINT (675905.1 636811.4)
3   3471.974 POINT (677688.9 635054.2)
4   3700.716   POINT (677707 634815.6)
5   2769.278 POINT (677144.5 632232.1)
6   2311.752   POINT (675848 632013.4)
7   3060.588 POINT (676008.2 632788.8)
8   2983.907 POINT (676611.1 632615.2)
9   3437.586   POINT (677951 632575.7)
10  2723.564   POINT (678588 631040.8)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(pres_vars_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 77,091
Columns: 23
$ timestamp  &lt;chr&gt; "2020-11-06 19:10:39", "2020-11-07 01:07:00", "2020-11-07 0…
$ season     &lt;chr&gt; "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
$ individual &lt;int&gt; 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
$ occurrence &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ forest     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ conifer    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ broadleaf  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ mixedwood  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ wetland    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ shrubland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ grassland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ barren     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ snowice    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ elevation  &lt;dbl&gt; 688.2874, 721.8030, 732.6952, 734.0319, 725.3831, 741.4588,…
$ slope      &lt;dbl&gt; 1.3049368, 1.1596124, 0.6464857, 0.5722326, 0.8816819, 1.11…
$ aspect     &lt;dbl&gt; 76.21446, 13.66821, 54.27378, 48.41456, 106.66216, 138.7282…
$ roughness  &lt;dbl&gt; 1.6730957, 1.4671021, 0.9449463, 0.8459473, 1.1493530, 1.65…
$ northness  &lt;dbl&gt; 0.23828828, 0.97168040, 0.58391279, 0.66373616, -0.28672776…
$ eastness   &lt;dbl&gt; 0.97119445, 0.23629901, 0.81181639, 0.74796677, 0.95801210,…
$ fires      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ dist2line  &lt;dbl&gt; 2468.400, 870.000, 3113.069, 3340.793, 3495.612, 3180.000, …
$ dist2poly  &lt;dbl&gt; 2539.390, 2309.026, 3471.974, 3700.716, 2769.278, 2311.752,…
$ geom       &lt;POINT [m]&gt; POINT (678102.7 642940.6), POINT (675905.1 636811.4),…</code></pre>
</div>
</div>
</section>
<section id="availability-data" class="level2">
<h2 class="anchored" data-anchor-id="availability-data">Availability data</h2>
<p><strong>Create availability points and extract raster values</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>npoints <span class="ot">&lt;-</span> <span class="fu">nrow</span>(pres_vars)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>nseasons <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">'earlywinter'</span>,<span class="fu">length</span>(gps<span class="sc">$</span>season[gps<span class="sc">$</span>season<span class="sc">==</span><span class="st">'earlywinter'</span>])),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rep</span>(<span class="st">'latewinter'</span>,<span class="fu">length</span>(gps<span class="sc">$</span>season[gps<span class="sc">$</span>season<span class="sc">==</span><span class="st">'latewinter'</span>])),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rep</span>(<span class="st">'summer'</span>,<span class="fu">length</span>(gps<span class="sc">$</span>season[gps<span class="sc">$</span>season<span class="sc">==</span><span class="st">'summer'</span>])),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rep</span>(<span class="st">'fallrut'</span>,<span class="fu">length</span>(gps<span class="sc">$</span>season[gps<span class="sc">$</span>season<span class="sc">==</span><span class="st">'fallrut'</span>])))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>avail_vars <span class="ot">&lt;-</span> <span class="fu">spatSample</span>(rasters, <span class="at">size=</span>npoints, <span class="at">method=</span><span class="st">"random"</span>, <span class="at">as.df=</span><span class="cn">TRUE</span>, <span class="at">values=</span><span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>avail_vars_sf <span class="ot">&lt;-</span>  <span class="fu">st_as_sf</span>(avail_vars, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs=</span><span class="dv">3578</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">occurrence=</span><span class="dv">0</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">geom=</span>geometry) <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season=</span>nseasons)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>avail_vars_sf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 77091 features and 20 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 503895 ymin: 466005 xmax: 731595 ymax: 666405
Projected CRS: NAD83 / Yukon Albers
First 10 features:
   forest conifer broadleaf mixedwood wetland shrubland grassland barren
1       1       1         0         0       0         0         0      0
2       0       0         0         0       0         0         0      1
3       0       0         0         0       0         0         0      1
4       1       1         0         0       0         0         0      0
5       1       1         0         0       0         0         0      0
6       1       1         0         0       0         0         0      0
7       0       0         0         0       0         0         0      1
8       0       0         0         0       0         0         0      1
9       0       0         0         0       0         1         0      0
10      1       1         0         0       0         0         0      0
   snowice elevation     slope    aspect roughness  northness   eastness fires
1        0  1163.516  4.489141  17.61655  5.915405  0.9531032  0.3026453     0
2        0  1789.354  7.946761 259.72220  9.735596 -0.1784211 -0.9839542     0
3        0  1640.539  5.798870 292.41071  7.956299  0.3812430 -0.9244749     0
4        0  1108.168  2.024624  62.65224  2.858398  0.4593900  0.8882347     0
5        0  1396.804 18.765089 257.41226 24.337524 -0.2179344 -0.9759634     0
6        0  1016.641  2.291878 149.51315  3.328064 -0.8617457  0.5073406     0
7        0  1609.093 26.367609 288.98950 37.801270  0.3253947 -0.9455783     0
8        0  1518.204  8.216177 301.22122 11.899414  0.5183436 -0.8551724     0
9        0  1621.803  5.131302 219.47391  7.584229 -0.7719142 -0.6357267     0
10       0  1436.484 17.258163 231.35103 26.198975 -0.6245473 -0.7809870     0
   dist2line dist2poly occurrence                  geom      season
1   2400.188 33278.652          0 POINT (650805 586245) earlywinter
2   2181.559 34552.941          0 POINT (617415 570225) earlywinter
3   9844.801 14397.906          0 POINT (642945 516555) earlywinter
4  13322.973 29602.826          0 POINT (633915 584145) earlywinter
5  11041.468 16569.236          0 POINT (588285 601095) earlywinter
6   9767.477 24492.496          0 POINT (548145 581325) earlywinter
7   8766.778 12606.070          0 POINT (639615 544215) earlywinter
8   4290.314 22710.715          0 POINT (612015 581685) earlywinter
9   1908.953  3914.511          0 POINT (658005 542895) earlywinter
10 18545.945 20566.023          0 POINT (632445 522135) earlywinter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(avail_vars_sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 77,091
Columns: 21
$ forest     &lt;dbl&gt; 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1,…
$ conifer    &lt;dbl&gt; 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1,…
$ broadleaf  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ mixedwood  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ wetland    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ shrubland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ grassland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0,…
$ barren     &lt;dbl&gt; 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0,…
$ snowice    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ elevation  &lt;dbl&gt; 1163.5155, 1789.3542, 1640.5393, 1108.1680, 1396.8044, 1016…
$ slope      &lt;dbl&gt; 4.4891410, 7.9467607, 5.7988701, 2.0246239, 18.7650890, 2.2…
$ aspect     &lt;dbl&gt; 17.61655, 259.72220, 292.41071, 62.65224, 257.41226, 149.51…
$ roughness  &lt;dbl&gt; 5.9154053, 9.7355957, 7.9562988, 2.8583984, 24.3375244, 3.3…
$ northness  &lt;dbl&gt; 0.9531032, -0.1784211, 0.3812430, 0.4593900, -0.2179344, -0…
$ eastness   &lt;dbl&gt; 0.30264527, -0.98395419, -0.92447490, 0.88823467, -0.975963…
$ fires      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ dist2line  &lt;dbl&gt; 2400.188, 2181.559, 9844.801, 13322.973, 11041.468, 9767.47…
$ dist2poly  &lt;dbl&gt; 33278.652, 34552.941, 14397.906, 29602.826, 16569.236, 2449…
$ occurrence &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ geom       &lt;POINT [m]&gt; POINT (650805 586245), POINT (617415 570225), POINT (…
$ season     &lt;chr&gt; "earlywinter", "earlywinter", "earlywinter", "earlywinter",…</code></pre>
</div>
</div>
<p>Add individual IDs using proportion of locations for each individual caribou as weights (prob)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>avail_ids <span class="ot">=</span> <span class="fu">sample</span>(<span class="fu">unique</span>(gps<span class="sc">$</span>individual), <span class="fu">nrow</span>(avail_vars_sf), <span class="at">replace=</span>T, <span class="at">prob=</span>gps_id_prop)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>avail_vars_sf<span class="sc">$</span>individual <span class="ot">&lt;-</span> avail_ids</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(avail_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>avail_ids
43140 43141 43142 43143 43144 43145 43146 43147 43148 43149 43150 43151 43152 
 4192  4104  4095  4235  4114  4196  4091   697  1831  2037  4274  4151  1820 
43153 43154 43155 43156 43157 43158 43159 43160 43161 43162 43163 43164 
  438  1878  4300  4125  1589  4203   645  2055  4191  4161  4164  1505 </code></pre>
</div>
</div>
</section>
<section id="combine-presence-and-availability-data" class="level2">
<h2 class="anchored" data-anchor-id="combine-presence-and-availability-data">Combine presence and availability data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gps_vars <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pres_vars_sf, avail_vars_sf) <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">timestamp=</span><span class="cn">NULL</span>) <span class="co"># id=1:nrow(.)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(gps_vars, <span class="st">'../../data/yt_caribou.gpkg'</span>, <span class="st">'gps_vars'</span>, <span class="at">delete_layer=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Deleting layer `gps_vars' using driver `GPKG'
Writing layer `gps_vars' to data source 
  `../../data/yt_caribou.gpkg' using driver `GPKG'
Writing 154182 features with 21 fields and geometry type Point.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(gps_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 154,182
Columns: 22
$ season     &lt;chr&gt; "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
$ individual &lt;int&gt; 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
$ occurrence &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ forest     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ conifer    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ broadleaf  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ mixedwood  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ wetland    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ shrubland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ grassland  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ barren     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ snowice    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ elevation  &lt;dbl&gt; 688.2874, 721.8030, 732.6952, 734.0319, 725.3831, 741.4588,…
$ slope      &lt;dbl&gt; 1.3049368, 1.1596124, 0.6464857, 0.5722326, 0.8816819, 1.11…
$ aspect     &lt;dbl&gt; 76.21446, 13.66821, 54.27378, 48.41456, 106.66216, 138.7282…
$ roughness  &lt;dbl&gt; 1.6730957, 1.4671021, 0.9449463, 0.8459473, 1.1493530, 1.65…
$ northness  &lt;dbl&gt; 0.23828828, 0.97168040, 0.58391279, 0.66373616, -0.28672776…
$ eastness   &lt;dbl&gt; 0.97119445, 0.23629901, 0.81181639, 0.74796677, 0.95801210,…
$ fires      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ dist2line  &lt;dbl&gt; 2468.400, 870.000, 3113.069, 3340.793, 3495.612, 3180.000, …
$ dist2poly  &lt;dbl&gt; 2539.390, 2309.026, 3471.974, 3700.716, 2769.278, 2311.752,…
$ geom       &lt;POINT [m]&gt; POINT (678102.7 642940.6), POINT (675905.1 636811.4),…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gps_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 21 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 675848 ymin: 632013.4 xmax: 678102.7 ymax: 642940.6
Projected CRS: NAD83 / Yukon Albers
       season individual occurrence forest conifer broadleaf mixedwood wetland
1 earlywinter      43163          1      1       1         0         0       0
2 earlywinter      43163          1      1       1         0         0       0
3 earlywinter      43163          1      1       1         0         0       0
4 earlywinter      43163          1      1       1         0         0       0
5 earlywinter      43163          1      1       1         0         0       0
6 earlywinter      43163          1      1       1         0         0       0
  shrubland grassland barren snowice elevation     slope    aspect roughness
1         0         0      0       0  688.2874 1.3049368  76.21446 1.6730957
2         0         0      0       0  721.8030 1.1596124  13.66821 1.4671021
3         0         0      0       0  732.6952 0.6464857  54.27378 0.9449463
4         0         0      0       0  734.0319 0.5722326  48.41456 0.8459473
5         0         0      0       0  725.3831 0.8816819 106.66216 1.1493530
6         0         0      0       0  741.4588 1.1163176 138.72826 1.6526489
   northness  eastness fires dist2line dist2poly                      geom
1  0.2382883 0.9711944     0  2468.400  2539.390 POINT (678102.7 642940.6)
2  0.9716804 0.2362990     0   870.000  2309.026 POINT (675905.1 636811.4)
3  0.5839128 0.8118164     0  3113.069  3471.974 POINT (677688.9 635054.2)
4  0.6637362 0.7479668     0  3340.793  3700.716   POINT (677707 634815.6)
5 -0.2867278 0.9580121     0  3495.612  2769.278 POINT (677144.5 632232.1)
6 -0.7515895 0.6596311     0  3180.000  2311.752   POINT (675848 632013.4)</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>