# Extract covariate values


## Introduction

Objectives:

- Extract raster covariate values

``` r
library(sf)
```

    Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE

``` r
library(terra)
```

    terra 1.7.78

``` r
library(tidyverse)
```

    ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ✔ ggplot2   3.5.1     ✔ tibble    3.2.1
    ✔ lubridate 1.9.3     ✔ tidyr     1.3.1
    ✔ purrr     1.0.2     

    ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ✖ tidyr::extract() masks terra::extract()
    ✖ dplyr::filter()  masks stats::filter()
    ✖ dplyr::lag()     masks stats::lag()
    ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
set.seed(5228)
```

## Presence data

**Prepare presence and availability points**

``` r
gps <- st_read('../../data/yt_caribou.gpkg', 'gps') |>
  mutate(individual=ID, occurrence=1, ID=NULL) |>
  filter(!season=='other')
```

    Reading layer `gps' from data source 
      `C:\Users\PIVER37\Desktop\Projects\little_rancheria\data\yt_caribou.gpkg' 
      using driver `GPKG'
    Simple feature collection with 90864 features and 3 fields
    Geometry type: POINT
    Dimension:     XY
    Bounding box:  xmin: 518681.7 ymin: 480918.5 xmax: 716666.7 ymax: 651698.2
    Projected CRS: NAD83 / Yukon Albers

``` r
glimpse(gps)
```

    Rows: 77,091
    Columns: 5
    $ timestamp  <chr> "2020-11-06 19:10:39", "2020-11-07 01:07:00", "2020-11-07 0…
    $ season     <chr> "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
    $ geom       <POINT [m]> POINT (678102.7 642940.6), POINT (675905.1 636811.4),…
    $ individual <int> 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
    $ occurrence <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…

**Calculate proportion of locations for each individual caribou**

``` r
gps_id_prop <- group_by(gps, individual) |>
  summarize(n=n()) |>
  mutate(freq=n/sum(n)) |>
  pull()
gps_id_prop
```

     [1] 0.053988144 0.054104889 0.053741682 0.054182719 0.054143804 0.054117861
     [7] 0.054014087 0.024205160 0.026916242 0.026060111 0.008366735 0.020495259
    [13] 0.054195691 0.053988144 0.054078946 0.009508244 0.005785371 0.053988144
    [19] 0.024205160 0.054130832 0.054027059 0.019691015 0.024010585 0.053988144
    [25] 0.054065974

**Read predictor rasters and concatenate them**

``` r
landcov <- rast('../../data/raster30/landcov.tif')
topo <- rast('../../data/raster30/topo.tif')
fires <- rast('../../data/raster30/fires.tif')
dist2line <- rast('../../data/raster30/dist2line.tif')
names(dist2line) <- "dist2line"
dist2poly <- rast('../../data/raster30/dist2poly.tif')
names(dist2poly) <- "dist2poly"
rasters <- c(landcov, topo, fires, dist2line, dist2poly)
names(rasters)
```

     [1] "forest"    "conifer"   "broadleaf" "mixedwood" "wetland"   "shrubland"
     [7] "grassland" "barren"    "snowice"   "elevation" "slope"     "aspect"   
    [13] "roughness" "northness" "eastness"  "fires"     "dist2line" "dist2poly"

``` r
rasters
```

    class       : SpatRaster 
    dimensions  : 6694, 7600, 18  (nrow, ncol, nlyr)
    resolution  : 30, 30  (x, y)
    extent      : 503670, 731670, 465900, 666720  (xmin, xmax, ymin, ymax)
    coord. ref. : NAD83 / Yukon Albers (EPSG:3578) 
    sources     : landcov.tif  (9 layers) 
                  topo.tif  (6 layers) 
                  fires.tif  
                  ... and 2 more source(s)
    names       : forest, conifer, broadleaf, mixedwood, wetland, shrubland, ... 
    min values  :      0,       0,         0,         0,       0,         0, ... 
    max values  :      1,       1,         1,         1,       1,         1, ... 

**Extract raster values for GPS locations**

``` r
pres_vars <- terra::extract(rasters, gps) |>
  mutate(ID=NULL)
pres_vars_sf <- cbind(gps, pres_vars)
pres_vars_sf
```

    Simple feature collection with 77091 features and 22 fields
    Geometry type: POINT
    Dimension:     XY
    Bounding box:  xmin: 518681.7 ymin: 480918.5 xmax: 716666.7 ymax: 651698.2
    Projected CRS: NAD83 / Yukon Albers
    First 10 features:
                 timestamp      season individual occurrence forest conifer
    1  2020-11-06 19:10:39 earlywinter      43163          1      1       1
    2  2020-11-07 01:07:00 earlywinter      43163          1      1       1
    3  2020-11-07 07:05:54 earlywinter      43163          1      1       1
    4  2020-11-07 13:04:39 earlywinter      43163          1      1       1
    5  2020-11-07 19:03:23 earlywinter      43163          1      1       1
    6  2020-11-08 01:02:25 earlywinter      43163          1      1       1
    7  2020-11-08 07:03:25 earlywinter      43163          1      1       1
    8  2020-11-08 13:00:38 earlywinter      43163          1      1       1
    9  2020-11-08 18:59:39 earlywinter      43163          1      1       1
    10 2020-11-09 00:58:38 earlywinter      43163          1      1       1
       broadleaf mixedwood wetland shrubland grassland barren snowice elevation
    1          0         0       0         0         0      0       0  688.2874
    2          0         0       0         0         0      0       0  721.8030
    3          0         0       0         0         0      0       0  732.6952
    4          0         0       0         0         0      0       0  734.0319
    5          0         0       0         0         0      0       0  725.3831
    6          0         0       0         0         0      0       0  741.4588
    7          0         0       0         0         0      0       0  748.1053
    8          0         0       0         0         0      0       0  735.0618
    9          0         0       0         0         0      0       0  728.0272
    10         0         0       0         0         0      0       0  728.3869
           slope    aspect roughness   northness   eastness fires dist2line
    1  1.3049368  76.21446 1.6730957  0.23828828  0.9711944     0  2468.400
    2  1.1596124  13.66821 1.4671021  0.97168040  0.2362990     0   870.000
    3  0.6464857  54.27378 0.9449463  0.58391279  0.8118164     0  3113.069
    4  0.5722326  48.41456 0.8459473  0.66373616  0.7479668     0  3340.793
    5  0.8816819 106.66216 1.1493530 -0.28672776  0.9580121     0  3495.612
    6  1.1163176 138.72826 1.6526489 -0.75158954  0.6596311     0  3180.000
    7  1.0377831  85.68446 1.1655884  0.07524924  0.9971648     0  3930.000
    8  1.4175920  96.07789 1.6336670 -0.10588032  0.9943789     0  3822.735
    9  0.4276250 197.99167 0.5642700 -0.95110142 -0.3088788     0  3976.896
    10 0.9032347  61.24379 1.2843628  0.48108381  0.8766746     0  2886.399
       dist2poly                      geom
    1   2539.390 POINT (678102.7 642940.6)
    2   2309.026 POINT (675905.1 636811.4)
    3   3471.974 POINT (677688.9 635054.2)
    4   3700.716   POINT (677707 634815.6)
    5   2769.278 POINT (677144.5 632232.1)
    6   2311.752   POINT (675848 632013.4)
    7   3060.588 POINT (676008.2 632788.8)
    8   2983.907 POINT (676611.1 632615.2)
    9   3437.586   POINT (677951 632575.7)
    10  2723.564   POINT (678588 631040.8)

``` r
glimpse(pres_vars_sf)
```

    Rows: 77,091
    Columns: 23
    $ timestamp  <chr> "2020-11-06 19:10:39", "2020-11-07 01:07:00", "2020-11-07 0…
    $ season     <chr> "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
    $ individual <int> 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
    $ occurrence <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ forest     <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ conifer    <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ broadleaf  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ mixedwood  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ wetland    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ shrubland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ grassland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ barren     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ snowice    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ elevation  <dbl> 688.2874, 721.8030, 732.6952, 734.0319, 725.3831, 741.4588,…
    $ slope      <dbl> 1.3049368, 1.1596124, 0.6464857, 0.5722326, 0.8816819, 1.11…
    $ aspect     <dbl> 76.21446, 13.66821, 54.27378, 48.41456, 106.66216, 138.7282…
    $ roughness  <dbl> 1.6730957, 1.4671021, 0.9449463, 0.8459473, 1.1493530, 1.65…
    $ northness  <dbl> 0.23828828, 0.97168040, 0.58391279, 0.66373616, -0.28672776…
    $ eastness   <dbl> 0.97119445, 0.23629901, 0.81181639, 0.74796677, 0.95801210,…
    $ fires      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ dist2line  <dbl> 2468.400, 870.000, 3113.069, 3340.793, 3495.612, 3180.000, …
    $ dist2poly  <dbl> 2539.390, 2309.026, 3471.974, 3700.716, 2769.278, 2311.752,…
    $ geom       <POINT [m]> POINT (678102.7 642940.6), POINT (675905.1 636811.4),…

## Availability data

**Create availability points and extract raster values**

``` r
npoints <- nrow(pres_vars)
nseasons <- c(rep('earlywinter',length(gps$season[gps$season=='earlywinter'])),
              rep('latewinter',length(gps$season[gps$season=='latewinter'])),
              rep('summer',length(gps$season[gps$season=='summer'])),
              rep('fallrut',length(gps$season[gps$season=='fallrut'])))
avail_vars <- spatSample(rasters, size=npoints, method="random", as.df=TRUE, values=TRUE, xy=TRUE, na.rm=TRUE)
avail_vars_sf <-  st_as_sf(avail_vars, coords = c("x", "y"), crs=3578) |>
  mutate(occurrence=0, x=NULL, y=NULL) |>
  rename(geom=geometry) |>
  mutate(season=nseasons)
avail_vars_sf
```

    Simple feature collection with 77091 features and 20 fields
    Geometry type: POINT
    Dimension:     XY
    Bounding box:  xmin: 503895 ymin: 466005 xmax: 731595 ymax: 666405
    Projected CRS: NAD83 / Yukon Albers
    First 10 features:
       forest conifer broadleaf mixedwood wetland shrubland grassland barren
    1       1       1         0         0       0         0         0      0
    2       0       0         0         0       0         0         0      1
    3       0       0         0         0       0         0         0      1
    4       1       1         0         0       0         0         0      0
    5       1       1         0         0       0         0         0      0
    6       1       1         0         0       0         0         0      0
    7       0       0         0         0       0         0         0      1
    8       0       0         0         0       0         0         0      1
    9       0       0         0         0       0         1         0      0
    10      1       1         0         0       0         0         0      0
       snowice elevation     slope    aspect roughness  northness   eastness fires
    1        0  1163.516  4.489141  17.61655  5.915405  0.9531032  0.3026453     0
    2        0  1789.354  7.946761 259.72220  9.735596 -0.1784211 -0.9839542     0
    3        0  1640.539  5.798870 292.41071  7.956299  0.3812430 -0.9244749     0
    4        0  1108.168  2.024624  62.65224  2.858398  0.4593900  0.8882347     0
    5        0  1396.804 18.765089 257.41226 24.337524 -0.2179344 -0.9759634     0
    6        0  1016.641  2.291878 149.51315  3.328064 -0.8617457  0.5073406     0
    7        0  1609.093 26.367609 288.98950 37.801270  0.3253947 -0.9455783     0
    8        0  1518.204  8.216177 301.22122 11.899414  0.5183436 -0.8551724     0
    9        0  1621.803  5.131302 219.47391  7.584229 -0.7719142 -0.6357267     0
    10       0  1436.484 17.258163 231.35103 26.198975 -0.6245473 -0.7809870     0
       dist2line dist2poly occurrence                  geom      season
    1   2400.188 33278.652          0 POINT (650805 586245) earlywinter
    2   2181.559 34552.941          0 POINT (617415 570225) earlywinter
    3   9844.801 14397.906          0 POINT (642945 516555) earlywinter
    4  13322.973 29602.826          0 POINT (633915 584145) earlywinter
    5  11041.468 16569.236          0 POINT (588285 601095) earlywinter
    6   9767.477 24492.496          0 POINT (548145 581325) earlywinter
    7   8766.778 12606.070          0 POINT (639615 544215) earlywinter
    8   4290.314 22710.715          0 POINT (612015 581685) earlywinter
    9   1908.953  3914.511          0 POINT (658005 542895) earlywinter
    10 18545.945 20566.023          0 POINT (632445 522135) earlywinter

``` r
glimpse(avail_vars_sf)
```

    Rows: 77,091
    Columns: 21
    $ forest     <dbl> 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1,…
    $ conifer    <dbl> 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1,…
    $ broadleaf  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ mixedwood  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ wetland    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ shrubland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ grassland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0,…
    $ barren     <dbl> 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0,…
    $ snowice    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ elevation  <dbl> 1163.5155, 1789.3542, 1640.5393, 1108.1680, 1396.8044, 1016…
    $ slope      <dbl> 4.4891410, 7.9467607, 5.7988701, 2.0246239, 18.7650890, 2.2…
    $ aspect     <dbl> 17.61655, 259.72220, 292.41071, 62.65224, 257.41226, 149.51…
    $ roughness  <dbl> 5.9154053, 9.7355957, 7.9562988, 2.8583984, 24.3375244, 3.3…
    $ northness  <dbl> 0.9531032, -0.1784211, 0.3812430, 0.4593900, -0.2179344, -0…
    $ eastness   <dbl> 0.30264527, -0.98395419, -0.92447490, 0.88823467, -0.975963…
    $ fires      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ dist2line  <dbl> 2400.188, 2181.559, 9844.801, 13322.973, 11041.468, 9767.47…
    $ dist2poly  <dbl> 33278.652, 34552.941, 14397.906, 29602.826, 16569.236, 2449…
    $ occurrence <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ geom       <POINT [m]> POINT (650805 586245), POINT (617415 570225), POINT (…
    $ season     <chr> "earlywinter", "earlywinter", "earlywinter", "earlywinter",…

Add individual IDs using proportion of locations for each individual
caribou as weights (prob)

``` r
avail_ids = sample(unique(gps$individual), nrow(avail_vars_sf), replace=T, prob=gps_id_prop)
avail_vars_sf$individual <- avail_ids
table(avail_ids)
```

    avail_ids
    43140 43141 43142 43143 43144 43145 43146 43147 43148 43149 43150 43151 43152 
     4192  4104  4095  4235  4114  4196  4091   697  1831  2037  4274  4151  1820 
    43153 43154 43155 43156 43157 43158 43159 43160 43161 43162 43163 43164 
      438  1878  4300  4125  1589  4203   645  2055  4191  4161  4164  1505 

## Combine presence and availability data

``` r
gps_vars <- bind_rows(pres_vars_sf, avail_vars_sf) %>%
  mutate(timestamp=NULL) # id=1:nrow(.)
st_write(gps_vars, '../../data/yt_caribou.gpkg', 'gps_vars', delete_layer=TRUE)
```

    Deleting layer `gps_vars' using driver `GPKG'
    Writing layer `gps_vars' to data source 
      `../../data/yt_caribou.gpkg' using driver `GPKG'
    Writing 154182 features with 21 fields and geometry type Point.

``` r
glimpse(gps_vars)
```

    Rows: 154,182
    Columns: 22
    $ season     <chr> "earlywinter", "earlywinter", "earlywinter", "earlywinter",…
    $ individual <int> 43163, 43163, 43163, 43163, 43163, 43163, 43163, 43163, 431…
    $ occurrence <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ forest     <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ conifer    <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    $ broadleaf  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ mixedwood  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ wetland    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ shrubland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ grassland  <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ barren     <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ snowice    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ elevation  <dbl> 688.2874, 721.8030, 732.6952, 734.0319, 725.3831, 741.4588,…
    $ slope      <dbl> 1.3049368, 1.1596124, 0.6464857, 0.5722326, 0.8816819, 1.11…
    $ aspect     <dbl> 76.21446, 13.66821, 54.27378, 48.41456, 106.66216, 138.7282…
    $ roughness  <dbl> 1.6730957, 1.4671021, 0.9449463, 0.8459473, 1.1493530, 1.65…
    $ northness  <dbl> 0.23828828, 0.97168040, 0.58391279, 0.66373616, -0.28672776…
    $ eastness   <dbl> 0.97119445, 0.23629901, 0.81181639, 0.74796677, 0.95801210,…
    $ fires      <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    $ dist2line  <dbl> 2468.400, 870.000, 3113.069, 3340.793, 3495.612, 3180.000, …
    $ dist2poly  <dbl> 2539.390, 2309.026, 3471.974, 3700.716, 2769.278, 2311.752,…
    $ geom       <POINT [m]> POINT (678102.7 642940.6), POINT (675905.1 636811.4),…

``` r
head(gps_vars)
```

    Simple feature collection with 6 features and 21 fields
    Geometry type: POINT
    Dimension:     XY
    Bounding box:  xmin: 675848 ymin: 632013.4 xmax: 678102.7 ymax: 642940.6
    Projected CRS: NAD83 / Yukon Albers
           season individual occurrence forest conifer broadleaf mixedwood wetland
    1 earlywinter      43163          1      1       1         0         0       0
    2 earlywinter      43163          1      1       1         0         0       0
    3 earlywinter      43163          1      1       1         0         0       0
    4 earlywinter      43163          1      1       1         0         0       0
    5 earlywinter      43163          1      1       1         0         0       0
    6 earlywinter      43163          1      1       1         0         0       0
      shrubland grassland barren snowice elevation     slope    aspect roughness
    1         0         0      0       0  688.2874 1.3049368  76.21446 1.6730957
    2         0         0      0       0  721.8030 1.1596124  13.66821 1.4671021
    3         0         0      0       0  732.6952 0.6464857  54.27378 0.9449463
    4         0         0      0       0  734.0319 0.5722326  48.41456 0.8459473
    5         0         0      0       0  725.3831 0.8816819 106.66216 1.1493530
    6         0         0      0       0  741.4588 1.1163176 138.72826 1.6526489
       northness  eastness fires dist2line dist2poly                      geom
    1  0.2382883 0.9711944     0  2468.400  2539.390 POINT (678102.7 642940.6)
    2  0.9716804 0.2362990     0   870.000  2309.026 POINT (675905.1 636811.4)
    3  0.5839128 0.8118164     0  3113.069  3471.974 POINT (677688.9 635054.2)
    4  0.6637362 0.7479668     0  3340.793  3700.716   POINT (677707 634815.6)
    5 -0.2867278 0.9580121     0  3495.612  2769.278 POINT (677144.5 632232.1)
    6 -0.7515895 0.6596311     0  3180.000  2311.752   POINT (675848 632013.4)
